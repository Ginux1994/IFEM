#!/bin/bash

# This script helps workaround current CPack (2.8.8) limitations
# 1) Fix the main deb to drop the '-bin' postfix
# 2) Fix -dev and -examples dependencies and descriptions
# 3) Remove dependencies from -doc and fix the description
#
# It expects to be run with debs in the cwd

function Unpack() {
  mkdir tmp
  dpkg-deb -R $1 tmp
  cd tmp/DEBIAN
}

function Pack() {
  sed '/^$/d' -i control
  cd ../..
  dpkg-deb -b tmp $1
  rm tmp -rf
}

path=`pwd`
mkdir -p UbuntuDebs
rm -f UbuntuDebs/*
arch=`dpkg --print-architecture`
code=`lsb_release -sc`
version=@IFEM_VERSION_MAJOR@.@IFEM_VERSION_MINOR@.@IFEM_VERSION_PATCH@
mkdir -p /tmp/debfixer
cd /tmp/debfixer

# Step 1
Unpack $path/libifem_${version}_$arch-$code-bin.deb
echo "Suggests: libifem-examples, libifem-doc" >> control
echo "Depends: libarpack2, liblapack3gf, libsuperlu3, libhdf5-serial-1.8.4, libtinyxml2.6.2" >> control
sed -i control -e 's/-bin//g'
Pack $path/UbuntuDebs/libifem_${version}_$arch-$code.deb
rm -f $path/libifem_${version}_$arch-$code-bin.deb

# Step 2
Unpack $path/libifem_${version}_$arch-$code-dev.deb
echo "Suggests: libifem-examples, libifem-doc" >> control
echo "Depends: libifem, libtinyxml-dev, libblas-dev, liblapack-dev, libarpack2-dev, libsuperlu3-dev, libvtfexpressapi-dev" >> control
sed -i control -e 's/\(Description: .*$\)/\1 - development headers/g'
sed -i control -e 's/\(Architecture: .*$\)/Architecture: all/g'
Pack $path/UbuntuDebs/libifem-dev_${version}_all-$code.deb
rm -f $path/libifem_${version}_$arch-$code-dev.deb

Unpack $path/libifem_${version}_$arch-$code-examples.deb
echo "Suggests: libifem-doc" >> control
echo "Depends: libifem-dev" >> control
sed -i control -e 's/\(Description: .*$\)/\1 - examples/g'
sed -i control -e 's/\(Architecture: .*$\)/Architecture: all/g'
Pack $path/UbuntuDebs/libifem-examples_${version}_all-$code.deb
rm -f $path/libifem_${version}_$arch-$code-examples.deb

# Step 3
Unpack $path/libifem_${version}_$arch-$code-doc.deb
echo -e "Suggests: libifem-examples" >> control
sed -i control -e 's/\(Description: .*$\)/\1 - documentation/g'
sed -i control -e 's/\(Architecture: .*$\)/Architecture: all/g'
Pack $path/UbuntuDebs/libifem-doc_${version}_all-$code.deb
rm -f $path/libifem_${version}_$arch-$code-doc.deb

rmdir /tmp/debfixer
